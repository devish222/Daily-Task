<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Task Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2fe; /* Lighter blue background */
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 2.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }
        .header h1 {
            font-size: 2.8rem;
            font-weight: 800;
            color: #1a202c;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }
        .header p {
            font-size: 1.2rem;
            color: #4b5563;
        }
        .section-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            border-bottom: 3px solid #bfdbfe; /* Softer blue border */
            padding-bottom: 0.75rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
        }
        .task-item {
            display: flex;
            align-items: center;
            padding: 1rem 0.5rem;
            border-bottom: 1px solid #e0e7eb; /* Softer border */
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            border-radius: 8px; /* Rounded corners for task items */
            margin-bottom: 0.5rem;
        }
        .task-item:last-child {
            border-bottom: none;
        }
        .task-item:hover {
            background-color: #f0f9ff; /* Lighter hover background */
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .checkbox-container {
            width: 28px;
            height: 28px;
            border: 2px solid #9ca3af;
            border-radius: 8px; /* More rounded checkbox */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1.2rem;
            transition: all 0.3s ease-in-out;
            flex-shrink: 0;
        }
        .checkbox-container.completed {
            background-color: #10b981; /* Green */
            border-color: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
        }
        .checkbox-container.completed .fa-check {
            color: #fff;
            font-size: 1.2rem;
        }
        .task-text {
            flex-grow: 1;
            font-size: 1.15rem;
            color: #374151;
            transition: color 0.3s ease-in-out, text-decoration 0.3s ease-in-out;
        }
        .task-text.completed {
            text-decoration: line-through;
            color: #6b7280;
            font-style: italic;
        }
        .smiley-emoji {
            margin-left: 0.8rem;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            transform: scale(0.8);
        }
        .smiley-emoji.visible {
            opacity: 1;
            transform: scale(1);
        }
        .add-task-form {
            background-color: #f0f9ff; /* Light blue background */
            padding: 2rem;
            border-radius: 12px;
            margin-top: 2.5rem;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.08);
        }
        .add-task-form h3 {
            color: #2563eb;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }
        .add-task-form input,
        .add-task-form select {
            width: 100%;
            padding: 0.9rem;
            border: 1px solid #a7d3f2; /* Softer border */
            border-radius: 8px;
            margin-bottom: 1.2rem;
            font-size: 1rem;
            color: #374151;
            background-color: #fff;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .add-task-form input:focus,
        .add-task-form select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .add-task-form button {
            background: linear-gradient(90deg, #3b82f6, #2563eb); /* Gradient button */
            color: #fff;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
            border: none;
        }
        .add-task-form button:hover {
            background: linear-gradient(90deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4);
        }
        .chart-container {
            margin-top: 3rem;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 16px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        }
        .chart-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            text-align: center;
            border-bottom: 2px solid #bfdbfe;
            padding-bottom: 0.75rem;
        }
        .notice {
            margin-top: 3rem;
            padding: 1.5rem;
            background: linear-gradient(45deg, #d1fae5, #a7f3d0); /* Gradient for positive notice */
            color: #065f46;
            border-radius: 12px;
            text-align: center;
            font-weight: 700;
            font-size: 1.2rem;
            display: none;
            box-shadow: 0 4px 12px rgba(6, 95, 70, 0.2);
            animation: fadeIn 1s ease-out forwards;
        }
        .notice.visible {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .export-button {
            background: linear-gradient(90deg, #10b981, #059669); /* Green gradient */
            color: #fff;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
            border: none;
            margin-top: 2rem;
            display: block;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        .export-button:hover {
            background: linear-gradient(90deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(16, 185, 129, 0.4);
        }
        .copy-feedback {
            margin-top: 1rem;
            text-align: center;
            color: #065f46;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }
        .copy-feedback.visible {
            opacity: 1;
        }
        .task-actions {
            margin-left: auto; /* Pushes buttons to the right */
            display: flex;
            gap: 0.5rem;
        }
        .task-actions button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0.4rem;
            border-radius: 4px;
            transition: background-color 0.2s ease-in-out;
        }
        .task-actions button.edit-btn {
            color: #3b82f6; /* Blue for edit */
        }
        .task-actions button.edit-btn:hover {
            background-color: #e0f2fe;
        }
        .task-actions button.delete-btn {
            color: #ef4444; /* Red for delete */
        }
        .task-actions button.delete-btn:hover {
            background-color: #fee2e2;
        }

        /* Custom Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .modal-overlay.visible .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .modal-content h4 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #1f2937;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .modal-buttons button {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
        }
        .modal-buttons .confirm-btn {
            background-color: #ef4444; /* Red for confirm */
            color: #fff;
        }
        .modal-buttons .confirm-btn:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        .modal-buttons .cancel-btn {
            background-color: #e5e7eb; /* Light gray for cancel */
            color: #374151;
        }
        .modal-buttons .cancel-btn:hover {
            background-color: #d1d5db;
            transform: translateY(-1px);
        }

        /* Responsive Adjustments for Mobile */
        @media (max-width: 768px) {
            .container {
                margin: 1rem; /* Smaller margin on mobile */
                padding: 1rem; /* Smaller padding on mobile */
                border-radius: 8px; /* Slightly less rounded */
            }
            .header h1 {
                font-size: 2rem; /* Smaller font size for header */
            }
            .header p {
                font-size: 1rem; /* Smaller font size for date */
            }
            .section-title {
                font-size: 1.5rem; /* Smaller section titles */
                margin-bottom: 1rem;
            }
            .task-item {
                padding: 0.75rem 0.25rem; /* Smaller padding for task items */
            }
            .task-text {
                font-size: 1rem; /* Smaller task text */
            }
            .smiley-emoji {
                font-size: 1.2rem; /* Smaller emoji */
            }
            .add-task-form {
                padding: 1rem; /* Smaller padding for form */
            }
            .add-task-form h3 {
                font-size: 1.2rem; /* Smaller form title */
            }
            .add-task-form input,
            .add-task-form select,
            .add-task-form button {
                padding: 0.7rem; /* Smaller padding for form elements */
                font-size: 0.9rem; /* Smaller font size for form elements */
            }
            .chart-container {
                margin-top: 2rem;
                padding: 1rem;
                border-radius: 8px;
            }
            .chart-title {
                font-size: 1.3rem; /* Smaller chart titles */
            }
            .export-button {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            .notice {
                padding: 1rem;
                font-size: 1rem;
            }
            /* Ensure charts don't become too small vertically on mobile */
            canvas {
                min-height: 250px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            .section-title {
                font-size: 1.3rem;
            }
            .task-text {
                font-size: 0.95rem;
            }
            .smiley-emoji {
                font-size: 1rem;
            }
            .task-actions button {
                font-size: 0.9rem;
                padding: 0.2rem;
            }
            .modal-content {
                padding: 1.5rem;
                margin: 0 1rem; /* Add horizontal margin for very small screens */
            }
            .modal-content h4 {
                font-size: 1.2rem;
            }
            .modal-buttons button {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            canvas {
                min-height: 200px; /* Even smaller min-height for very small screens */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Daily Task Tracker</h1>
            <p id="current-date"></p>
        </div>

        <!-- Daily Must Tasks -->
        <div class="mb-8">
            <h2 class="section-title">Daily Must Tasks</h2>
            <div id="daily-must-tasks"></div>
        </div>

        <!-- Lifestyle Activity -->
        <div class="mb-8">
            <h2 class="section-title">Lifestyle Activity</h2>
            <div id="lifestyle-tasks"></div>
        </div>

        <!-- Daily Exam Related and Other Tasks -->
        <div class="mb-8">
            <h2 class="section-title">Daily Exam Related and Other Tasks</h2>
            <div id="exam-other-tasks"></div>

            <div class="add-task-form">
                <h3 class="text-xl font-semibold mb-4 text-gray-700" id="exam-form-title">Add New Exam/Other Task</h3>
                <input type="text" id="new-task-name" placeholder="Task Name" class="focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <input type="number" id="new-task-duration" placeholder="Duration (minutes)" class="focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <select id="new-task-topic" class="focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select Topic</option>
                    <option value="Maths">Maths</option>
                    <option value="Reasoning">Reasoning</option>
                    <option value="Computer Knowledge">Computer Knowledge</option>
                    <option value="English">English</option>
                    <option value="Current Affairs">Current Affairs</option>
                    <option value="New Skill">New Skill</option>
                    <option value="Other Activity">Other Activity</option>
                    <option value="Home Activity">Home Activity</option>
                </select>
                <button onclick="handleExamTaskSubmission()" class="w-full" id="exam-form-button">Add Task</button>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="chart-container">
            <h2 class="chart-title">Task Completion by Section</h2>
            <canvas id="taskCompletionBySectionChart"></canvas>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Task Completion Rates</h2>
            <canvas id="taskCompletionRatesChart"></canvas>
        </div>

        <button class="export-button" onclick="exportTasksToCSV()">Download Tasks as CSV</button>
        <div id="copy-feedback" class="copy-feedback"></div>


        <div class="notice" id="positive-day-notice">
            Your day is looking positive! Keep up the great work! ðŸ˜Š
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h4 id="confirm-modal-message">Are you sure you want to delete this task?</h4>
            <div class="modal-buttons">
                <button class="confirm-btn" id="confirm-modal-yes">Yes</button>
                <button class="cancel-btn" id="confirm-modal-no">No</button>
            </div>
        </div>
    </div>

    <script>
        // Initial task data
        let dailyMustTasks = [
            { name: "10 gratitude to universe", completed: false },
            { name: "ETF", completed: false },
            { name: "Read your affirmations", completed: false },
            { name: "Magic Water", completed: false },
            { name: "108 ho'opnopo", completed: false },
            { name: "Visualization in front of God", completed: false },
            { name: "Go to temple", completed: false },
            { name: "Write Affirmations 3 times", completed: false },
            { name: "Write Affirmation 6 Times", completed: false },
            { name: "EFT", completed: false },
            { name: "DMP", completed: false },
            { name: "Write Affirmations 9 times", completed: false },
            { name: "Ho'opnopo Music", completed: false },
            { name: "Mirror and water techniques with affirmations (1)", completed: false },
            { name: "Mirror and water techniques with affirmations (2)", completed: false },
            { name: "Mirror and water techniques with affirmations (3)", completed: false },
            { name: "Mirror and water techniques with affirmations (4)", completed: false },
            { name: "Mirror and water techniques with affirmations (5)", completed: false }
        ];

        let lifestyleTasks = [
            { name: "30 minutes of exercises", completed: false },
            { name: "Love myself and love everyone and help everyone unconditionally.", completed: false },
            { name: "Read / Learn about new technology and finance related knowledge", completed: false },
            { name: "Earn money daily (Increasing day by day)", completed: false }
        ];

        let examOtherTasks = []; // User can add these dynamically

        // Chart instances
        let taskCompletionBySectionChart;
        let taskCompletionRatesChart;

        // Variable to store the index of the task being edited
        let editingTaskIndex = null;

        /**
         * Renders tasks for a given section.
         * @param {Array<Object>} tasks - The array of task objects.
         * @param {string} containerId - The ID of the HTML element to render tasks into.
         * @param {string} sectionName - The name of the section (e.g., 'dailyMust', 'lifestyle', 'examOther').
         */
        function renderTasks(tasks, containerId, sectionName) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear previous tasks

            tasks.forEach((task, index) => {
                const taskItem = document.createElement('div');
                taskItem.className = `task-item ${task.completed ? 'completed' : ''}`;

                const checkboxContainer = document.createElement('div');
                checkboxContainer.className = `checkbox-container ${task.completed ? 'completed' : ''}`;
                checkboxContainer.innerHTML = `<i class="fas fa-check"></i>`;
                checkboxContainer.onclick = (e) => {
                    e.stopPropagation(); // Prevent task item click from triggering
                    toggleTaskCompletion(sectionName, index);
                };

                const taskText = document.createElement('span');
                taskText.className = `task-text ${task.completed ? 'completed' : ''}`;
                taskText.textContent = task.name;
                taskText.onclick = (e) => {
                    e.stopPropagation(); // Prevent task item click from triggering
                    toggleTaskCompletion(sectionName, index);
                };


                if (sectionName === 'examOther' && task.duration) {
                    taskText.textContent += ` (Duration: ${task.duration} mins, Topic: ${task.topic})`;
                }

                const smileyEmoji = document.createElement('span');
                smileyEmoji.className = `smiley-emoji ${task.completed ? 'visible' : ''}`;
                smileyEmoji.textContent = 'ðŸ˜Š';

                taskItem.appendChild(checkboxContainer);
                taskItem.appendChild(taskText);

                // Add edit and delete buttons only for Exam & Other tasks
                if (sectionName === 'examOther') {
                    const taskActions = document.createElement('div');
                    taskActions.className = 'task-actions';

                    const editButton = document.createElement('button');
                    editButton.className = 'edit-btn';
                    editButton.innerHTML = '<i class="fas fa-edit"></i>';
                    editButton.title = 'Edit Task';
                    editButton.onclick = (e) => {
                        e.stopPropagation(); // Prevent task item click from triggering
                        editExamTask(index);
                    };

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'delete-btn';
                    deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteButton.title = 'Delete Task';
                    deleteButton.onclick = (e) => {
                        e.stopPropagation(); // Prevent task item click from triggering
                        deleteExamTask(index);
                    };

                    taskActions.appendChild(editButton);
                    taskActions.appendChild(deleteButton);
                    taskItem.appendChild(taskActions);
                }

                taskItem.appendChild(smileyEmoji);
                container.appendChild(taskItem);
            });
        }

        /**
         * Toggles the completion status of a task.
         * @param {string} sectionName - The name of the section.
         * @param {number} index - The index of the task in its array.
         */
        function toggleTaskCompletion(sectionName, index) {
            let tasks;
            if (sectionName === 'dailyMust') {
                tasks = dailyMustTasks;
            } else if (sectionName === 'lifestyle') {
                tasks = lifestyleTasks;
            } else if (sectionName === 'examOther') {
                tasks = examOtherTasks;
            }

            if (tasks && tasks[index]) {
                tasks[index].completed = !tasks[index].completed;
                updateUI();
            }
        }

        /**
         * Handles the submission of new or edited exam/other tasks.
         */
        function handleExamTaskSubmission() {
            const taskNameInput = document.getElementById('new-task-name');
            const taskDurationInput = document.getElementById('new-task-duration');
            const taskTopicSelect = document.getElementById('new-task-topic');
            const formButton = document.getElementById('exam-form-button');
            const formTitle = document.getElementById('exam-form-title');

            const name = taskNameInput.value.trim();
            const duration = parseInt(taskDurationInput.value);
            const topic = taskTopicSelect.value;

            if (name && !isNaN(duration) && duration > 0 && topic) {
                if (editingTaskIndex !== null) {
                    // Edit existing task
                    examOtherTasks[editingTaskIndex].name = name;
                    examOtherTasks[editingTaskIndex].duration = duration;
                    examOtherTasks[editingTaskIndex].topic = topic;
                    editingTaskIndex = null; // Reset editing state
                    formButton.textContent = 'Add Task';
                    formTitle.textContent = 'Add New Exam/Other Task';
                    showFeedbackMessage('Task updated successfully!', 'success');
                } else {
                    // Add new task
                    examOtherTasks.push({
                        name: name,
                        completed: false,
                        duration: duration,
                        topic: topic
                    });
                    showFeedbackMessage('Task added successfully!', 'success');
                }
                taskNameInput.value = '';
                taskDurationInput.value = '';
                taskTopicSelect.value = '';
                updateUI();
            } else {
                showFeedbackMessage('Please enter a valid task name, duration, and select a topic.', 'error');
            }
        }

        /**
         * Populates the form for editing an exam task.
         * @param {number} index - The index of the task to edit.
         */
        function editExamTask(index) {
            const task = examOtherTasks[index];
            if (task) {
                document.getElementById('new-task-name').value = task.name;
                document.getElementById('new-task-duration').value = task.duration;
                document.getElementById('new-task-topic').value = task.topic;

                document.getElementById('exam-form-button').textContent = 'Save Changes';
                document.getElementById('exam-form-title').textContent = 'Edit Exam/Other Task';
                editingTaskIndex = index;
            }
        }

        /**
         * Deletes an exam task after confirmation.
         * @param {number} index - The index of the task to delete.
         */
        function deleteExamTask(index) {
            showConfirmModal('Are you sure you want to delete this task?', () => {
                examOtherTasks.splice(index, 1);
                updateUI();
                showFeedbackMessage('Task deleted successfully!', 'success');
            });
        }

        /**
         * Calculates completion percentages for each section.
         * @param {Array<Object>} tasks - The array of task objects.
         * @returns {number} The completion percentage.
         */
        function calculateCompletionPercentage(tasks) {
            if (tasks.length === 0) return 0;
            const completedTasks = tasks.filter(task => task.completed).length;
            return (completedTasks / tasks.length) * 100;
        }

        /**
         * Updates all charts with current data.
         */
        function updateCharts() {
            const dailyMustCompleted = dailyMustTasks.filter(task => task.completed).length;
            const lifestyleCompleted = lifestyleTasks.filter(task => task.completed).length;
            const examOtherCompleted = examOtherTasks.filter(task => task.completed).length;

            const dailyMustTotal = dailyMustTasks.length;
            const lifestyleTotal = lifestyleTasks.length;
            const examOtherTotal = examOtherTasks.length;

            const dailyMustPercentage = calculateCompletionPercentage(dailyMustTasks);
            const lifestylePercentage = calculateCompletionPercentage(lifestyleTasks);
            const examOtherPercentage = calculateCompletionPercentage(examOtherTasks);

            // Calculate overall completion
            const allTasks = [...dailyMustTasks, ...lifestyleTasks, ...examOtherTasks];
            const overallCompleted = allTasks.filter(task => task.completed).length;
            const overallTotal = allTasks.length;
            const overallPercentage = overallTotal > 0 ? (overallCompleted / overallTotal) * 100 : 0;

            // Update Task Completion by Section Chart
            if (taskCompletionBySectionChart) {
                taskCompletionBySectionChart.data.datasets[0].data = [dailyMustCompleted, lifestyleCompleted, examOtherCompleted];
                taskCompletionBySectionChart.data.datasets[1].data = [dailyMustTotal, lifestyleTotal, examOtherTotal];
                taskCompletionBySectionChart.update();
            } else {
                const ctx1 = document.getElementById('taskCompletionBySectionChart').getContext('2d');
                taskCompletionBySectionChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Daily Must', 'Lifestyle', 'Exam & Other'],
                        datasets: [
                            {
                                label: 'Completed',
                                data: [dailyMustCompleted, lifestyleCompleted, examOtherCompleted],
                                backgroundColor: '#3b82f6', /* Blue */
                                borderRadius: 8,
                                categoryPercentage: 0.7, /* Adjust bar width */
                                barPercentage: 0.8 /* Adjust bar width */
                            },
                            {
                                label: 'Total',
                                data: [dailyMustTotal, lifestyleTotal, examOtherTotal],
                                backgroundColor: '#ef4444', /* Red */
                                borderRadius: 8,
                                categoryPercentage: 0.7, /* Adjust bar width */
                                barPercentage: 0.8 /* Adjust bar width */
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true, /* Changed to true */
                        aspectRatio: 1.5, /* Set aspect ratio for better mobile display */
                        indexAxis: 'x', // Vertical bars
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 14
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.raw;
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Sections',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Tasks',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    stepSize: 2, // Ensure ticks are integers
                                }
                            }
                        }
                    }
                });
            }

            // Update Task Completion Rates Chart
            if (taskCompletionRatesChart) {
                taskCompletionRatesChart.data.datasets[0].data = [dailyMustPercentage, lifestylePercentage, examOtherPercentage];
                taskCompletionRatesChart.options.plugins.title.text = `Task Completion Rates (${overallCompleted}/${overallTotal} - ${overallPercentage.toFixed(1)}%)`;
                taskCompletionRatesChart.update();
            } else {
                const ctx2 = document.getElementById('taskCompletionRatesChart').getContext('2d');
                taskCompletionRatesChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['Daily Must', 'Lifestyle', 'Exam & Other'],
                        datasets: [{
                            label: 'Completion %',
                            data: [dailyMustPercentage, lifestylePercentage, examOtherPercentage],
                            backgroundColor: ['#3b82f6', '#ef4444', '#22c55e'], /* Blue, Red, Green */
                            borderRadius: 8,
                            categoryPercentage: 0.7, /* Adjust bar width */
                            barPercentage: 0.8 /* Adjust bar width */
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true, /* Changed to true */
                        aspectRatio: 1.5, /* Set aspect ratio for better mobile display */
                        indexAxis: 'y', // Horizontal bars
                        plugins: {
                            legend: {
                                display: false,
                            },
                            title: {
                                display: true,
                                text: `Task Completion Rates (${overallCompleted}/${overallTotal} - ${overallPercentage.toFixed(1)}%)`,
                                font: {
                                    size: 18,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10,
                                    bottom: 10
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.raw.toFixed(1)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Completion %',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Section',
                                    font: {
                                        size: 16,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            // Show/hide positive day notice
            const positiveDayNotice = document.getElementById('positive-day-notice');
            if (overallPercentage >= 70 && overallTotal > 0) { // You can adjust this threshold
                positiveDayNotice.classList.add('visible');
            } else {
                positiveDayNotice.classList.remove('visible');
            }
        }

        /**
         * Generates CSV content from current tasks and triggers a download.
         */
        function exportTasksToCSV() {
            let csvContent = `Daily Task Tracker Data - ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}\n\n`;

            // --- Daily Must Tasks Section ---
            csvContent += "Daily Must Tasks\n";
            csvContent += "Task Name,Completed\n";
            dailyMustTasks.forEach(task => {
                csvContent += `"${task.name}",${task.completed ? 'Yes' : 'No'}\n`;
            });
            const dailyMustPercentage = calculateCompletionPercentage(dailyMustTasks);
            csvContent += `\nCompletion Percentage:,${dailyMustPercentage.toFixed(1)}%\n\n`;

            // --- Lifestyle Activity Section ---
            csvContent += "Lifestyle Activity\n";
            csvContent += "Task Name,Completed\n";
            lifestyleTasks.forEach(task => {
                csvContent += `"${task.name}",${task.completed ? 'Yes' : 'No'}\n`;
            });
            const lifestylePercentage = calculateCompletionPercentage(lifestyleTasks);
            csvContent += `\nCompletion Percentage:,${lifestylePercentage.toFixed(1)}%\n\n`;

            // --- Daily Exam Related and Other Tasks Section ---
            csvContent += "Daily Exam Related and Other Tasks\n";
            csvContent += "Task Name,Completed,Duration (minutes),Topic\n";
            examOtherTasks.forEach(task => {
                const duration = task.duration ? task.duration : '';
                const topic = task.topic ? task.topic : '';
                csvContent += `"${task.name}",${task.completed ? 'Yes' : 'No'},"${duration}","${topic}"\n`;
            });
            const examOtherPercentage = calculateCompletionPercentage(examOtherTasks);
            csvContent += `\nCompletion Percentage:,${examOtherPercentage.toFixed(1)}%\n\n`;

            // --- Overall Summary Table ---
            const allTasks = [...dailyMustTasks, ...lifestyleTasks, ...examOtherTasks];
            const overallCompleted = allTasks.filter(task => task.completed).length;
            const overallTotal = allTasks.length;
            const overallPercentage = overallTotal > 0 ? (overallCompleted / overallTotal) * 100 : 0;

            csvContent += "Overall Task Completion Summary\n";
            csvContent += "Section,Completed Tasks,Total Tasks,Completion Percentage\n";
            csvContent += `"Daily Must",${dailyMustTasks.filter(task => task.completed).length},${dailyMustTasks.length},${dailyMustPercentage.toFixed(1)}%\n`;
            csvContent += `"Lifestyle",${lifestyleTasks.filter(task => task.completed).length},${lifestyleTasks.length},${lifestylePercentage.toFixed(1)}%\n`;
            csvContent += `"Exam & Other",${examOtherTasks.filter(task => task.completed).length},${examOtherTasks.length},${examOtherPercentage.toFixed(1)}%\n`;
            csvContent += `"ALL SECTIONS",${overallCompleted},${overallTotal},${overallPercentage.toFixed(1)}%\n`;


            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'daily_tasks.csv');
            link.style.visibility = 'hidden'; // Hide the link
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Clean up the URL object

            showFeedbackMessage('CSV file downloaded!', 'success');
        }

        /**
         * Displays a temporary feedback message to the user.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error' for styling.
         */
        function showFeedbackMessage(message, type) {
            const feedbackDiv = document.getElementById('copy-feedback');
            feedbackDiv.textContent = message;
            feedbackDiv.className = `copy-feedback visible ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
            setTimeout(() => {
                feedbackDiv.classList.remove('visible');
            }, 3000); // Hide after 3 seconds
        }

        /**
         * Displays a custom confirmation modal.
         * @param {string} message - The message to display in the modal.
         * @param {function} onConfirmCallback - Function to execute if 'Yes' is clicked.
         */
        function showConfirmModal(message, onConfirmCallback) {
            const modalOverlay = document.getElementById('confirm-modal-overlay');
            const modalMessage = document.getElementById('confirm-modal-message');
            const confirmYesButton = document.getElementById('confirm-modal-yes');
            const confirmNoButton = document.getElementById('confirm-modal-no');

            modalMessage.textContent = message;
            modalOverlay.classList.add('visible');

            // Clear previous event listeners to prevent multiple calls
            confirmYesButton.onclick = null;
            confirmNoButton.onclick = null;

            confirmYesButton.onclick = () => {
                onConfirmCallback();
                hideConfirmModal();
            };
            confirmNoButton.onclick = () => {
                hideConfirmModal();
            };
        }

        /**
         * Hides the custom confirmation modal.
         */
        function hideConfirmModal() {
            document.getElementById('confirm-modal-overlay').classList.remove('visible');
        }


        /**
         * Updates the entire UI.
         */
        function updateUI() {
            renderTasks(dailyMustTasks, 'daily-must-tasks', 'dailyMust');
            renderTasks(lifestyleTasks, 'lifestyle-tasks', 'lifestyle');
            renderTasks(examOtherTasks, 'exam-other-tasks', 'examOther');
            updateCharts();
        }

        // Set current date
        function setCurrentDate() {
            const dateElement = document.getElementById('current-date');
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateElement.textContent = today.toLocaleDateString('en-US', options);
        }

        // Initial load
        window.onload = function() {
            setCurrentDate();
            updateUI();
        };
    </script>
</body>
</html>
